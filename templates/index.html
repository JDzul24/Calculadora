<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora con Árbol y Tabla de Tokens</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #2c3e50;
            color: white;
        }
        .table {
            color: white;
        }
        .table thead th {
            color: white;
        }
        .calculator {
            background-color: #34495e;
            border-radius: 10px;
            padding: 15px;
        }
        .btn-dark {
            background-color: #2c3e50;
        }
        .btn-secondary {
            background-color: #34495e;
        }
        .tree-container img {
            max-width: 100%;
            background-color: white;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <!-- Tabla de Tokens -->
            <div class="col-md-4">
                <div class="card bg-dark">
                    <div class="card-header text-center">
                        <h3>Tabla de Tokens</h3>
                    </div>
                    <div class="card-body">
                        <div id="token-table-container" class="table-responsive">
                            <table class="table table-dark table-bordered">
                                <thead>
                                    <tr>
                                        <th>Token</th>
                                        <th>Tipo</th>
                                    </tr>
                                </thead>
                                <tbody id="token-table-body">
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td id="total-tokens" colspan="2">Total: 0</td>
                                    </tr>
                                    <tr>
                                        <td id="total-integers" colspan="2">Enteros: 0</td>
                                    </tr>
                                    <tr>
                                        <td id="total-decimals" colspan="2">Decimales: 0</td>
                                    </tr>
                                    <tr>
                                        <td id="total-operators" colspan="2">Operadores: 0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calculadora -->
            <div class="col-md-4">
                <div class="calculator">
                    <div class="screen mb-3">
                        <input type="text" id="memory" class="form-control text-end mb-1" placeholder="Memoria" readonly>
                        <input type="text" id="expression" class="form-control text-end" placeholder="0">
                    </div>
                    <div class="buttons d-grid gap-2">
                        <div class="row g-2">
                            <div class="col-3"><button class="btn btn-secondary w-100">(</button></div>
                            <div class="col-3"><button class="btn btn-secondary w-100">)</button></div>
                            <div class="col-3"><button class="btn btn-danger w-100" id="clear">C</button></div>
                            <div class="col-3"><button class="btn btn-danger w-100" id="backspace">←</button></div>
                        </div>
                        <div class="row g-2">
                            <div class="col-3"><button class="btn btn-dark w-100">7</button></div>
                            <div class="col-3"><button class="btn btn-dark w-100">8</button></div>
                            <div class="col-3"><button class="btn btn-dark w-100">9</button></div>
                            <div class="col-3"><button class="btn btn-secondary w-100">/</button></div>
                        </div>
                        <div class="row g-2">
                            <div class="col-3"><button class="btn btn-dark w-100">4</button></div>
                            <div class="col-3"><button class="btn btn-dark w-100">5</button></div>
                            <div class="col-3"><button class="btn btn-dark w-100">6</button></div>
                            <div class="col-3"><button class="btn btn-secondary w-100">*</button></div>
                        </div>
                        <div class="row g-2">
                            <div class="col-3"><button class="btn btn-dark w-100">1</button></div>
                            <div class="col-3"><button class="btn btn-dark w-100">2</button></div>
                            <div class="col-3"><button class="btn btn-dark w-100">3</button></div>
                            <div class="col-3"><button class="btn btn-secondary w-100">-</button></div>
                        </div>
                        <div class="row g-2">
                            <div class="col-3"><button class="btn btn-dark w-100">0</button></div>
                            <div class="col-3"><button class="btn btn-dark w-100">.</button></div>
                            <div class="col-3"><button class="btn btn-secondary w-100">e</button></div>
                            <div class="col-3"><button class="btn btn-secondary w-100">+</button></div>
                        </div>
                        <div class="row g-2">
                            <div class="col-3"><button class="btn btn-secondary w-100">sqrt</button></div>
                            <div class="col-3"><button class="btn btn-secondary w-100">^</button></div>
                            <div class="col-6"><button id="calculate" class="btn btn-warning w-100">=</button></div>
                        </div>
                        <div class="row g-2 mt-2">
                            <div class="col-3"><button id="memory-save" class="btn btn-info w-100">MS</button></div>
                            <div class="col-3"><button id="memory-recall" class="btn btn-info w-100">MR</button></div>
                            <div class="col-3"><button id="generate-tree" class="btn btn-info w-100">Árbol</button></div>
                            <div class="col-3"><button id="generate-table" class="btn btn-info w-100">Tabla</button></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Árbol de derivación -->
            <div class="col-md-4">
                <div class="card bg-dark">
                    <div class="card-header text-center">
                        <h3>Árbol de Derivación</h3>
                    </div>
                    <div class="card-body">
                        <div id="tree-container" class="tree-container">
                            <img src="" id="treeImage" class="img-fluid" alt="Árbol de derivación">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const buttons = document.querySelectorAll(".buttons .btn");
        const expressionInput = document.getElementById("expression");
        const memoryInput = document.getElementById("memory");
        const calculateButton = document.getElementById("calculate");
        const generateTreeButton = document.getElementById("generate-tree");
        const generateTableButton = document.getElementById("generate-table");
        const memorySaveButton = document.getElementById("memory-save");
        const memoryRecallButton = document.getElementById("memory-recall");
        const treeImage = document.getElementById("treeImage");
        const tokenTableBody = document.getElementById("token-table-body");
        const totalTokens = document.getElementById("total-tokens");
        const totalIntegers = document.getElementById("total-integers");
        const totalDecimals = document.getElementById("total-decimals");
        const totalOperators = document.getElementById("total-operators");
        const clearButton = document.getElementById("clear");
        const backspaceButton = document.getElementById("backspace");

        const savedOperations = JSON.parse(localStorage.getItem('calculatorOperations')) || [];
        let memory = 0;

        function updateSavedOperations(operation, result) {
            savedOperations.push({ operation, result });
            localStorage.setItem('calculatorOperations', JSON.stringify(savedOperations));
        }

        memorySaveButton.addEventListener("click", () => {
            const currentExpression = expressionInput.value;
            if (currentExpression) {
                fetch("/calculate", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: `expression=${encodeURIComponent(currentExpression)}`
                })
                .then(handleApiError)
                .then(data => {
                    memory = data.result;
                    memoryInput.value = memory;
                })
                .catch(error => {
                    alert(error.message);
                });
            }
        });

        memoryRecallButton.addEventListener("click", () => {
            expressionInput.value += memory;
        });

        buttons.forEach(button => {
            button.addEventListener("click", () => {
                const value = button.innerText;
                if (!["Árbol", "Tabla"].includes(value)) { // Ignorar botones "Árbol" y "Tabla"
                    if (["sqrt", "e", "^"].includes(value)) {
                        expressionInput.value += value + "(";
                    } else {
                        expressionInput.value += value;
                    }
                }
            });
        });


        clearButton.addEventListener("click", () => {
            expressionInput.value = "";
            treeImage.src = "";
            tokenTableBody.innerHTML = "";
            updateTokenCounts(0, 0, 0, 0);
        });

        backspaceButton.addEventListener("click", () => {
            expressionInput.value = expressionInput.value.slice(0, -1);
        });

        generateTreeButton.addEventListener("click", () => {
            const expression = expressionInput.value;
            if (!expression) return;

            fetch("/calculate", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `expression=${encodeURIComponent(expression)}`
            })
            .then(handleApiError)
            .then(data => {
                if (data.tree) {
                    treeImage.src = data.tree + "?t=" + new Date().getTime();
                }
            })
            .catch(error => {
                alert(error.message);
            });
        });

        generateTableButton.addEventListener("click", () => {
            const expression = expressionInput.value;
            if (!expression) return;

            fetch("/calculate", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `expression=${encodeURIComponent(expression)}`
            })
            .then(handleApiError)
            .then(data => {
                tokenTableBody.innerHTML = data.tokens.map(token =>
                    `<tr>
                        <td>${token}</td>
                        <td>${getTokenType(token)}</td>
                    </tr>`
                ).join('');

                updateTokenCounts(data.total_tokens, data.total_integers, data.total_decimals, data.total_operators);
            })
            .catch(error => {
                alert(error.message);
            });
        });

        calculateButton.addEventListener("click", () => {
            const expression = expressionInput.value;
            if (!expression) return;

            fetch("/calculate", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `expression=${encodeURIComponent(expression)}`
            })
            .then(handleApiError)
            .then(data => {
                updateSavedOperations(expression, data.result);

                expressionInput.value = data.result;

                if (data.tree) {
                    treeImage.src = data.tree + "?t=" + new Date().getTime();
                }

                tokenTableBody.innerHTML = data.tokens.map(token =>
                    `<tr>
                        <td>${token}</td>
                        <td>${getTokenType(token)}</td>
                    </tr>`
                ).join('');

                updateTokenCounts(data.total_tokens, data.total_integers, data.total_decimals, data.total_operators);
            })
            .catch(error => {
                alert(error.message);
            });
        });

        function handleApiError(response) {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Error in operation');
                });
            }
            return response.json();
        }

        expressionInput.addEventListener("keydown", (event) => {
            const allowedKeys = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "+", "-", "*", "/", "(", ")", ".", "e", "s", "q", "r", "t", "^"];

            if (!allowedKeys.includes(event.key) && !["Backspace", "Delete", "ArrowLeft", "ArrowRight"].includes(event.key)) {
                event.preventDefault();
            }

            if (event.key === "Enter") {
                calculateButton.click();
            }
        });

        function getTokenType(token) {
            if (typeof token === 'number' && Number.isInteger(token)) {
                return 'Entero';
            } else if (typeof token === 'number') {
                return 'Decimal';
            } else if (['+', '-', '*', '/', '^'].includes(token)) {
                return 'Operador';
            } else if (['sqrt', 'e'].includes(token)) {
                return 'Función';
            } else {
                return 'Otro';
            }
        }

        function updateTokenCounts(total, integers, decimals, operators) {
            totalTokens.textContent = `Total: ${total}`;
            totalIntegers.textContent = `Enteros: ${integers}`;
            totalDecimals.textContent = `Decimales: ${decimals}`;
            totalOperators.textContent = `Operadores: ${operators}`;
        }
    </script>
</body>
</html>
